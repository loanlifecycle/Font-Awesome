machine:
  environment:
    DEPLOY_TOOLKIT: $HOME/deploy_toolkit
    FAILURE_FILE: /tmp/build_failures.txt
    DEPLOY_TOOLKIT_BRANCH: <DEPLOY_TOOLKIT_BRANCH>
    GITHUB_USER: CircleCI-ncino
    GITHUB_REPO_OWNER: loanlifecycle
    GITHUB_REPO: Font-Awesome
  node:
    version: 6.9.0

dependencies:
  pre:
    - |
      if [ "$DEPLOY_TOOLKIT_BRANCH" == "<DEPLOY_TOOLKIT_BRANCH>" ]; then DEPLOY_TOOLKIT_BRANCH="master"; fi
      echo "Checking out branch: $DEPLOY_TOOLKIT_BRANCH\n"
      git clone -b $DEPLOY_TOOLKIT_BRANCH git@github.com:loanlifecycle/deploy_toolkit.git $DEPLOY_TOOLKIT
    - sudo gem install bundler
    - npm install -g grunt grunt-cli less less-plugin-clean-css
    - go get github.com/aktau/github-release || ( touch $FAILURE_FILE && exit 1 )
  override:
    - $DEPLOY_TOOLKIT/scripts/installation/install_dependencies_for_python.sh || ( touch $FAILURE_FILE && exit 1 )
    - cd $DEPLOY_TOOLKIT && npm install -g || ( touch $FAILURE_FILE && exit 1 )
    - sfdeploy -d report_build_info -lt off || ( touch $FAILURE_FILE && exit 1 )
    - bundle install || ( touch $FAILURE_FILE && exit 1 )
    - npm install || ( touch $FAILURE_FILE && exit 1 )

test:
  override:
    - bundle exec jekyll build || ( touch $FAILURE_FILE && exit 1 )
  post:
    - cp "$HOME/Font-Awesome/dist/assets/font-awesome/font-awesome.zip" "$CIRCLE_ARTIFACTS/font-awesome.resource"
    - |
      export GITHUB_TAG="$(date +%s)"
      github-release release -u "$GITHUB_REPO_OWNER" -t "$GITHUB_TAG" -n "Font-Awesome Static Resource" -d "This is a CI generated binary release."
      github-release upload  -u "$GITHUB_REPO_OWNER" -t "$GITHUB_TAG" -f "$CIRCLE_ARTIFACTS/font-awesome.resource" --n 'font-awesome.resource'
    - $DEPLOY_TOOLKIT/scripts/build_notifications.py

deployment:
  binary_build:
    branch: master
    commands:
      - |
        export GITHUB_TAG="$(date +%s)"
        github-release release -u "$GITHUB_REPO_OWNER" -t "$GITHUB_TAG" -n "Font-Awesome Static Resource" -d "This is a CI generated binary release."
        github-release upload  -u "$GITHUB_REPO_OWNER" -t "$GITHUB_TAG" -f "$CIRCLE_ARTIFACTS/font-awesome.resource" --n 'font-awesome.resource'